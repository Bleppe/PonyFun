<div class="dashboard-container">
  <header class="dashboard-header">
    <div class="dashboard-header-content">
      <img src="/logo_transparent.png" alt="PonyFun Logo" class="dashboard-logo" />
      <div class="header-controls">
        <div class="scrape-controls">
          <button class="scrape-btn danger" (click)="cleanDatabase()" [disabled]="loading">
            {{ loading ? 'Cleaning...' : 'ğŸ—‘ï¸ Clean Database' }}
          </button>
          <button class="scrape-btn secondary" (click)="triggerScrapeAll()" [disabled]="loading">
            {{ loading ? 'Searching...' : 'Find All Future Rounds' }}
          </button>
          <button class="scrape-btn" (click)="triggerScrape()" [disabled]="loading">
            {{ loading ? 'Scraping...' : 'Fetch Latest Data (ATG + SH)' }}
          </button>
          <a routerLink="/riders" class="scrape-btn info">ğŸ† Top Riders Analysis</a>
        </div>
      </div>
    </div>
  </header>

  <section class="race-list">
    <div *ngIf="loading" class="spinner-container">
      <div class="spinner"></div>
    </div>

    <div *ngIf="!loading">
      <div class="venue-section" *ngFor="let key of getGroupKeys()">
        <div class="venue-header" (click)="toggleGroup(key)">
          <div class="header-left">
            <h2 class="venue-title">{{ key }}</h2>
            <div class="system-cost-details" *ngIf="calculateSystemCost(key) > 0">
              <span class="system-cost">System Cost: {{ calculateSystemCost(key) | number:'1.2-2' }} SEK</span>
              <div class="participant-calculator">
                <input type="number" [(ngModel)]="participants" min="1" class="participants-input" />
                <span class="cost-per-person">
                  ({{ calculateSystemCost(key) / participants | number:'1.2-2' }} SEK/person)
                </span>
              </div>
            </div>
          </div>
          <span class="toggle-icon" [class.collapsed]="!isGroupExpanded(key)">â–¼</span>
        </div>
        <div class="cards-grid" *ngIf="isGroupExpanded(key)">
          <div class="race-card" *ngFor="let race of groupedRaces[key]">
            <h3>Race {{ race.race_number }}</h3>
            <p>Horses: {{ race.horse_count }}</p>

            <div class="selected-horses" *ngIf="getSelectedHorses(race.track, race.date, race.race_number).length > 0">
              <span class="selection-label">Bets:</span>
              <div class="badges-row">
                <span class="selection-badge"
                  *ngFor="let num of getSelectedHorses(race.track, race.date, race.race_number)">{{ num }}</span>
              </div>
            </div>
            <div class="race-actions">
              <a [routerLink]="['/analysis', race.race_number]" [queryParams]="{track: race.track, date: race.date}"
                class="analyze-btn">
                Analyze Race
              </a>
              <a [routerLink]="['/rider-analysis', race.race_number]"
                [queryParams]="{track: race.track, date: race.date}" class="analyze-btn rider-view-btn">
                ğŸ‡ Rider View
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!loading && upcomingRaces.length === 0" class="empty-state">
      No data available. Use the button above to scrape V85 data.
    </div>
  </section>

  <!-- Mascot -->
  <img src="/mascot_transparent.png" alt="Unicorn Pirate Mascot" class="mascot" />
</div>