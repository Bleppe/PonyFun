<div class="analysis-container">
    <header class="analysis-header">
        <div class="venue-badge" *ngIf="track">{{ track }} - {{ date }}</div>
        <div class="nav-row">
            <a routerLink="/" class="back-link">‚Üê Back to Dashboard</a>
            <div class="header-nav">
                <button class="nav-btn" (click)="goToPreviousRace()" [disabled]="raceId === 1">‚Üê Prev Race</button>
                <h1>Race {{ raceId }}</h1>
                <button class="nav-btn" (click)="goToNextRace()" [disabled]="raceId === 8">Next Race ‚Üí</button>
            </div>
            <div class="spacer"></div>
        </div>
    </header>

    <div *ngIf="loading" class="spinner-container">
        <div class="spinner"></div>
    </div>

    <div class="table-wrapper" *ngIf="!loading && analysis.length > 0">
        <div class="scroll-hint">‚Üê Scroll to see more ‚Üí</div>
        <table class="analysis-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>No.</th>
                    <th>Horse</th>
                    <th class="hide-mobile">Rider</th>
                    <th>Win %</th>
                    <th class="hide-mobile">V85 %</th>
                    <th>Edge</th>
                    <th>Form</th>
                    <th class="hide-mobile">Records</th>
                    <th class="hide-mobile">Earnings</th>
                    <th>üí¨</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let horse of analysis; let i = index" [class.scratched]="horse.is_scratched">
                    <td class="rank-cell">{{ i + 1 }}{{ i === 0 ? 'st' : i === 1 ? 'nd' : i === 2 ? 'rd' : 'th' }}</td>
                    <td class="num-cell">{{ horse.horse_number }}</td>
                    <td class="horse-name">{{ horse.name }}</td>
                    <td class="hide-mobile">{{ horse.rider }}</td>
                    <td class="prob-cell">{{ (horse.calculated_probability * 100).toFixed(1) }}%</td>
                    <td class="hide-mobile">{{ horse.bet_percentage }}%</td>
                    <td [class.positive-edge]="horse.calculated_probability * 100 > horse.bet_percentage">
                        {{ (horse.calculated_probability * 100 - horse.bet_percentage).toFixed(1) }}%
                    </td>
                    <td><span class="form-badge">{{ horse.recent_form }}</span></td>
                    <td class="hide-mobile">{{ horse.record_auto }} / {{ horse.record_volt }}</td>
                    <td class="hide-mobile">{{ (horse.total_earnings / 1000).toFixed(0) }}k</td>
                    <td class="comment-cell" [class.has-comment]="horse.comment" (click)="toggleTooltip($event, i)">
                        <span *ngIf="horse.comment">üìù</span>
                        <div class="tooltip" *ngIf="horse.comment" [class.show]="activeTooltip === i"
                            [class.tooltip-bottom]="i < 2" (click)="$event.stopPropagation()">
                            {{ horse.comment }}
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div *ngIf="!loading && analysis.length === 0" class="empty-state">
        No analysis data found for this race.
    </div>

    <!-- Mascot -->
    <img src="/mascot_transparent.png" alt="Unicorn Pirate Mascot" class="mascot" />
</div>